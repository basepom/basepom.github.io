<!DOCTYPE html>


<!--
 | Generated by Apache Maven Doxia Site Renderer 2.0.0-M10 from src/site/markdown/writing_integration_test.md at 2023-05-21
 | Rendered using Apache Maven Fluido Skin 2.0.0-M6
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 2.0.0-M10" />
    <title>duplicate-finder-maven-plugin Maven Mojo</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-2.0.0-M6.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
    <script src="./js/apache-maven-fluido-2.0.0-M6.min.js"></script>
  </head>
  <body class="topBarDisabled">
    <a class="github-fork-ribbon right-top" href="https://github.com/basepom/duplicate-finder-maven-plugin" data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a>
    <div class="container-fluid">
      <header>
        <div id="banner">
          <div class="pull-left"></div>
          <div class="pull-right"></div>
          <div class="clear"><hr/></div>
        </div>

        <div id="breadcrumbs">
          <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2023-05-21<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 2.0.0</li>
          </ul>
        </div>
      </header>
      <div class="row-fluid">
        <header id="leftColumn" class="span2">
          <nav class="well sidebar-nav">
  <ul class="nav nav-list">
   <li class="nav-header">Overview</li>
    <li><a href="index.html" title="Introduction"><span class="none"></span>Introduction</a></li>
    <li><a href="plugin-info.html" title="Goals"><span class="none"></span>Goals</a></li>
    <li><a href="simple_options.html" title="Simple configuration"><span class="none"></span>Simple configuration</a></li>
    <li><a href="classpath_exceptions.html" title="Classpath Exceptions"><span class="none"></span>Classpath Exceptions</a></li>
    <li><a href="ignoring_dependencies_and_resources.html" title="Ignoring Dependencies and Resources"><span class="none"></span>Ignoring Dependencies and Resources</a></li>
    <li><a href="result_file_options.html" title="Result File Options"><span class="none"></span>Result File Options</a></li>
    <li><a title="Developer Information"><span class="icon-chevron-down"></span>Developer Information</a>
     <ul class="nav nav-list">
      <li><a href="development_guidelines.html" title="Development Guidelines"><span class="none"></span>Development Guidelines</a></li>
      <li class="active"><a><span class="none"></span>Writing Integration Tests</a></li>
      <li><a href="result_file_format.html" title="Result File Format"><span class="none"></span>Result File Format</a></li>
      <li><a href="default_ignored_elements.html" title="Default ignored elements"><span class="none"></span>Default ignored elements</a></li>
     </ul></li>
    <li><a href="https://www.apache.org/licenses/LICENSE-2.0" class="externalLink" title="License"><span class="none"></span>License</a></li>
   <li class="nav-header">Project Documentation</li>
    <li><a href="project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a></li>
    <li><a href="project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a></li>
  </ul>
          </nav>
          <div class="well sidebar-nav">
            <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </header>
        <main id="bodyColumn"  class="span10" >
<p>The duplicate finder plugin comes with a comprehensive integration test suite to ensure its behavior.</p>
<p>Integration tests are executed using the <a href="http://maven.apache.org/plugins/maven-invoker-plugin/integration-test-mojo.html" class="externalLink">Maven Invoker Plugin</a>. The test suite comes with a set of tools that makes writing integration tests simple.</p><section><section><section>
<h3>Writing an integration test for the duplicate finder plugin</h3>
<p>Integration tests are located in the <a href="https://github.com/basepom/duplicate-finder-maven-plugin/tree/master/src/it" class="externalLink"><code>src/it</code></a> folder of the source tree. Any directory that starts with <code>test-</code> contains an integration test. All integration tests are always executed as part of the plugin build process.</p>
<p>Any integration test directory <strong>must</strong> contain at least three files:</p>
<ul>

<li><code>pom.xml</code> - The project POM, which must inherit from the base POM</li>
<li><code>invoker.properties</code> - The goals to invoke and the expected outcome.</li>
<li><code>verify.groovy</code> - The result verification script. All integration tests use groovy.</li>
</ul>
<p>Tests that add code, compile classes etc. may have more files.</p><section>
<h4>The integration test POM</h4>
<p>Any integration test must inherit from the base POM which sets up the plugin correctly. That ensures that any global change in the future will be picked up by all unit tests.</p>
<p>The POM for any integration test should look like this:</p>

<div class="verbatim">
<pre><code class="language-xml">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&quot;&gt;

  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

  &lt;parent&gt;
    &lt;groupId&gt;@project.groupId@.@project.artifactId@&lt;/groupId&gt;
    &lt;artifactId&gt;basepom&lt;/artifactId&gt;
    &lt;version&gt;1.0.under-test&lt;/version&gt;
  &lt;/parent&gt;

  &lt;artifactId&gt;... the artifact id of the test ...&lt;/artifactId&gt;
  &lt;description&gt;... brief description what the test tries to accomplish ...&lt;/description&gt;

... additional POM elements ...
&lt;/project&gt;
</code></pre></div>
<p>Any integration test must use the name of its directory as the artifactId. As integration test directory names must start with <code>test-</code>, any integration test artifactId must be <code>test-....</code>.</p></section><section>
<h4>The <code>invoker.properties</code> file</h4>
<p>All integration tests should contain almost identical <code>invoker.properties</code> files:</p>

<div class="verbatim">
<pre><code class="language-properties">invoker.goals=clean verify
invoker.buildResult = success
</code></pre></div>
<p>for a successful plugin execution</p>

<div class="verbatim">
<pre><code class="language-properties">invoker.goals=clean verify
invoker.buildResult = failure
</code></pre></div>
<p>for an unsuccessful plugin execution.</p>
<p>The integration test should still write a duplicate plugin result file which then is verified using the <code>verify.groovy</code> script</p></section><section>
<h4>The <code>verify.groovy</code> script</h4>
<p>Almost all integration tests will use the result file output after a plugin run to check the outcome. The integration test suite contains a library which makes these checks reasonably simple.</p>
<p>The <code>ITools</code> library is based on the <a href="http://groovy.codehaus.org/Reading+XML+using+Groovy%27s+XmlSlurper" class="externalLink">XmlSlurper</a> library; additional processing can be done with the tools listed there.</p>
<p>The source code for the <code>ITools</code> library <a href="https://github.com/basepom/duplicate-finder-maven-plugin/blob/master/src/test/groovy/org/basepom/mojo/duplicatefinder/ITools.groovy" class="externalLink">is in the main source tree</a>. Also, the existing integration tests serve as examples on how to write tests and verify plugin results.</p>
<p>Any <code>verify.groovy</code> script should start with</p>

<div class="verbatim">
<pre><code class="language-groovy">import static org.basepom.mojo.duplicatefinder.groovy.ITools.*

def result = loadTestXml(basedir)
...
</code></pre></div>
<p>This loads the result file information for the <code>test</code> classpath scope into the <code>result</code> variable.</p>
<p>Any test that needs to validate from a different scope or must access elements that are not enclosed by a <code>result</code> element need to use</p>

<div class="verbatim">
<pre><code class="language-groovy">def (result, xml) = loadXmlAndResult(basedir, &quot;runtime&quot;)
</code></pre></div>
<p>Here the <code>xml</code> variable will contain the full result file element tree and <code>result</code> will contain the test result for the <code>runtime</code> scope.</p>
<p>Checking the general outcome of an integration test:</p>

<div class="verbatim">
<pre><code class="language-groovy">overallState(conflictState, count, failState, result)
</code></pre></div>
<ul>

<li><code>conflictState</code> can be <code>NO_CONFLICT</code>, <code>CONFLICT_EQUAL</code> or <code>CONFLICT_DIFF</code> (constants are defined in the <code>ITools</code> library)</li>
<li><code>failState</code> can be <code>FAILED</code> or <code>NOT_FAILED</code>  (constants are defined in the <code>ITools</code> library)</li>
<li><code>count</code> is the number of elements in conflict state. Note that multiple conflicts between the same elements (e.g. the <code>first-jar</code> and <code>second-jar</code>) only count as one.</li>
<li><code>result</code> is the value returned by <code>loadTestXml</code> or <code>loadXmlAndResult</code> or <code>loadXml</code>.</li>
</ul>
<p>Do a conflict check:</p>

<div class="verbatim">
<pre><code class="language-groovy">checkConflictResult(conflictName, conflictType, conflictState, excepted, printed, failState, conflictResult)
</code></pre></div>
<ul>

<li><code>conflictName</code> is the class or resource name that is in conflict.</li>
<li><code>conflictType</code> can be <code>TYPE_CLASS</code> or <code>TYPE_RESOURCE</code> (constants are defined in the <code>ITools</code> library)</li>
<li><code>conflictState</code> can be <code>NO_CONFLICT</code>, <code>CONFLICT_EQUAL</code> or <code>CONFLICT_DIFF</code> (constants are defined in the <code>ITools</code> library)</li>
<li><code>excepted</code> can be <code>NOT_EXCEPTED</code> or <code>EXCEPTED</code> (constants are defined in the <code>ITools</code> library). An <code>excepted</code> conflict is covered by an <code>&lt;exception&gt;</code> element from the configuration.</li>
<li><code>printed</code> can be <code>NOT_PRINTED</code> or <code>PRINTED</code> (constants are defined in the <code>ITools</code> library). A <code>PRINTED</code> conflict was reported on the command line.</li>
<li><code>failState</code> can be <code>FAILED</code> or <code>NOT_FAILED</code>  (constants are defined in the <code>ITools</code> library). A <code>FAILED</code> conflict also failed the build.</li>
</ul>
<p>The following tools help build the <code>conflictResult</code> value:</p>

<div class="verbatim">
<pre><code class="language-groovy">findConflictResult(result, String ... matches)

findConflictResult(result, count, String ... matches)
</code></pre></div>
<ul>

<li>
<p><code>result</code> is the value returned by <code>loadTestXml</code> or <code>loadXmlAndResult</code> or <code>loadXml</code>.</p></li>
<li>
<p><code>count</code> is the number of expected result elements that match all of the <code>matches</code> elements. If omitted, <em>1</em> is assumed.</p></li>
<li>
<p><code>matches</code> A list of element names that match the test results.</p></li>
<li>
<p>For the predefined jars, the <em>Match name</em> (see below) can be used.</p></li>
<li>
<p>For a match from the local project, the <code>projectTargetFolder(basedir)</code> and <code>projectTargetTestFolder(basedir)</code> tools can be used.</p></li>
</ul></section><section>
<h4>Jars for duplication checks</h4>
<p>As the duplicate finder plugin deals with a classpath elements, there are a number of pre-built jars that can be used in an integration test:</p>
<table class="table table-striped">
<thead>
<tr class="a">
<th>Maven GAV coordinates</th>
<th>Contents</th>
<th>Match name</th>
<th>Usage</th></tr></thead><tbody>
<tr class="b">
<td><code>testjar:first-class-jar:1.0.under-test</code></td>
<td><code>diff.Demo</code> class</td>
<td><code>FIRST_CLASS_JAR</code></td>
<td>Use with <code>first-diff-jar</code> to find classpath class duplicates with different SHA</td></tr>
<tr class="a">
<td><code>testjar:second-class-jar:1.0.under-test</code></td>
<td><code>demo.Demo</code> class</td>
<td><code>SECOND_CLASS_JAR</code></td>
<td>Use with <code>second-equal-jar</code> to find classpath class duplicates with same SHA</td></tr>
<tr class="b">
<td><code>testjar:first-diff-jar:1.0.under-test</code></td>
<td><code>diff.Demo</code> class, different SHA from <code>first-class-jar</code></td>
<td><code>FIRST_DIFF_JAR</code></td>
<td> </td></tr>
<tr class="a">
<td><code>testjar:second-equal-jar:1.0.under-test</code></td>
<td><code>demo.Demo</code> class, same SHA as <code>second-class-jar</code></td>
<td><code>SECOND_EQUAL_JAR</code></td>
<td> </td></tr>
<tr class="b">
<td><code>testjar:first-jar:1.0.under-test</code></td>
<td><code>conflict-same-content</code> and <code>conflict-different-content</code> resources</td>
<td><code>FIRST_JAR</code></td>
<td>Use with <code>second-jar</code> to find classpath resource duplicates with the same or different SHA values.</td></tr>
<tr class="a">
<td><code>testjar:second-jar:1.0.under-test</code></td>
<td><code>conflict-same-content</code> with the same SHA and <code>conflict-different-content</code> with a different SHA from <code>first-jar</code></td>
<td><code>SECOND_JAR</code></td>
<td> </td></tr></tbody>
</table>
</section></section><section>
<h3>Debugging an integration test</h3>
<p>As integration tests are intended to highlight an aspect of the plugin functionality, they are extremely useful for debugging / isolating of problems. To debug the plugin while executing an integration test, use the following steps:</p>
<ul>

<li>build and install the plugin locally, prepare the integration tests: <code>mvn -Dinvoker.test='setup*' clean install</code>. This step is required only once until the next time <code>mvn clean</code> is executed.</li>
<li>now build and run the integration test to debug: <code>mvn -Dinvoker.mavenOpts='-Xdebug -Xnoagent -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=8000' -Dinvoker.test='&lt;testname&gt;' invoker:integration-test</code>. This will execute the integration test and suspend the VM. A debugger can now attach to port 8000 to debug the plugin execution.</li>
</ul>
<p>If wildcards are given for the tests to run, a new JDK will be spawned for each integration test and the debugger must be attached multiple times.
If the plugin code has changed, either combine the <code>test</code> goal with <code>invoker:integration-test</code> or use the proper <code>integration-test</code> lifecycle goal.</p></section></section></section>
        </main>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>©      2014–2023
<a href="https://github.com/basepom">The basepom project</a>
</p>
        </div>
      </div>
    </footer>
<script>
  if(anchors) {
    anchors.add();
  }
</script>
  </body>
</html>